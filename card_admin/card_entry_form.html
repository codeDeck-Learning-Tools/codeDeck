<!DOCTYPE html>
<html lang="en">
<head>

  <!-- Basic Page Needs
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta charset="utf-8">
  <title>Cards Manager</title>

  <!-- Mobile Specific Metas
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- FONT
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link href="https://fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">

  <!-- CSS
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="stylesheet" href="normalize.css">
  <link rel="stylesheet" href="skeleton.css">
  <style>
    /* remove card button */
    .btnRemove {      
      margin: 0;
      line-height: 20px;
      height: 20px;
      max-width: 25px;
      padding: 0 5px;
      text-align: center;
    }
  </style>

  <!-- Favicon
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <!-- TODO: get a favicon for the project -->
  <!-- <link rel="icon" type="image/png" href="images/favicon.png"> -->
</head>
<body>

  <!-- Primary Page Layout
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <div class="container">

    <header>
      <h1>Manage Cards</h1>
      <hr>
    </header>

  <!-- Add Card Form
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <form>
      <h2>Add Card</h2>
      <!-- card meta inputs -->
      <h5>Meta</h5>
      <div class="row">
        <div class="six columns">
          <label for="txtTopic">Topic</label>
          <input class="u-full-width" type="text" placeholder="topic" id="txtTopic">
        </div>
        <div class="six columns">
          <label for="txtAuthor">Author</label>
          <input class="u-full-width" type="text" placeholder="name" id="txtAuthor">
        </div>
      </div>
      <div class="row">
        <label for="txtTags">Tags
          <span class="label-body">Separate each tag with a space.</span>
        </label>
        <input class="u-full-width" type="text" placeholder="git merge..." id="txtTags">
      </div>

      <!-- front of card -->
      <h5>Front</h5>
      <label for="txtFront">Text (git command)</label>
      <input class="u-full-width" type="text" placeholder="git merge..." id="txtFront">
      
      <!-- back of card -->
      <h5>Back</h5>
      <label for="txtBack">Text (clue or question)</label>
      <textarea class="u-full-width" placeholder="What is..." id="txtBack"></textarea>    
      <input class="button-primary" type="submit" value="Add" id="btnSubmit">
    </form>

  <!-- Edit Card Form
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
<div id="editCardModal">
  <div class="modalContent">
    <form id="editCardForm">
      <span class="close">&times;</span>
      <h2>Edit Card</h2>
      <!-- card meta inputs -->
      <h5>Meta</h5>
      <div class="row">
        <div class="six columns">
          <label for="txtTopic">Topic</label>
          <input class="u-full-width" type="text" placeholder="topic" id="txtTopic">
        </div>
        <div class="six columns">
          <label for="txtAuthor">Author</label>
          <input class="u-full-width" type="text" placeholder="name" id="txtAuthor">
        </div>
      </div>
      <div class="row">
        <label for="txtTags">Tags
          <span class="label-body">Separate each tag with a space.</span>
        </label>
        <input class="u-full-width" type="text" placeholder="git merge..." id="txtTags">
      </div>
    
      <!-- front of card -->
      <h5>Front</h5>
      <label for="txtFront">Text (git command)</label>
      <input class="u-full-width" type="text" placeholder="git merge..." id="txtFront">
      
      <!-- back of card -->
      <h5>Back</h5>
      <label for="txtBack">Text (clue or question)</label>
      <textarea class="u-full-width" placeholder="What is..." id="txtBack"></textarea>    
      <input class="button-primary" type="submit" value="Add" id="btnSubmit">
    </form>
  </div>
</div>

    <!-- Cards table
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <p>
      Total cards: <span id="totalCards"></span>
    </p>
    <table class="u-full-width">
        <thead>
            <tr>
                <th>Topic</th>
                <th>Front</th>
                <th>Back</th>
                <th>Author</th>
                <th>Tags</th>
                <th>Delete</th>
            </tr>
        </thead>
        <tbody id="tblCards">
        </tbody>
    </table>
  </div> <!-- end container -->

<!-- End Document
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->

<!-- Firebase
–––––––––––––––––––––––––––––––––––––––––––––––––– -->
<script src="https://www.gstatic.com/firebasejs/4.2.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.2.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.2.0/firebase-database.js"></script>

<script src="https://code.jquery.com/jquery-3.2.1.min.js" 
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous"></script>

<!-- card entry script
–––––––––––––––––––––––––––––––––––––––––––––––––– -->
<script>
// Initialize Firebase
var config = {
    apiKey: "AIzaSyCAGvW613Tfgyi6e7a8e1U1Nh45tSvPjCo",
    authDomain: "codedeck-17e00.firebaseapp.com",
    databaseURL: "https://codedeck-17e00.firebaseio.com",
    projectId: "codedeck-17e00",
    storageBucket: "",
    messagingSenderId: "82313729151"
};
firebase.initializeApp(config);

/*
    ----- database -----

    Reference to firbase.database object with added application
    specific properties and methods. *** Be careful not to override
    the names defined in the firebase api.
*/
var database = firebase.database();
var refCards = database.ref("cards");

// Adds a card to the database
database.addCard = function(card) {

  // add card to the cards reference with a unique key
  refCards.push(card);
};

// Removes a card from the database
database.removeCard = function(key) {
  refCards.child(key).remove();
}

// listen for changes in the cards data
refCards.on("value", function(snapCards) {
  table.render(snapCards.toJSON());
  // update number of cards
  displayTotalCards(snapCards.numChildren());
});


/*
    ----- form -----

    Container for properties and methods for the add card form.
*/
var form = {

    // Gets input from the form and adds it to the database
    submit: function() {

        // get the input
        var card = {
            topic: $("#txtTopic").val().trim(),
            author: $("#txtAuthor").val().trim(),
            tags: $("#txtTags").val().trim(),
            front: {
                text: $("#txtFront").val().trim()
            },
            back: {
                text: $("#txtBack").val().trim()
            }
        };

        // reset front and back, leave meta fields unchanged
        $("#txtFront, #txtBack").val("");

        // set focus to topic input
        $("#txtTopic").focus();

        // add the card to the database
        database.addCard(card);
    }
};


/*
    ----- table -----

    Container for properties and methods for displaying cards data.

    TODO: add an edit button which will change to an edit card view,
          allow the user to make changes, and then save them or discard
          the changes.
*/
var table = {
  // Creates a row and returns it as a jquery object
  newRow: function(card, key="") {
    var $row = $("<tr>");

    // add data to row
    $("<td>").appendTo($row).text(card.topic);
    $("<td>").appendTo($row).text(card.front.text);
    $("<td>").appendTo($row).text(card.back.text);
    $("<td>").appendTo($row).text(card.author);
    $("<td>").appendTo($row).text(card.tags);

    // add remove button
    var $btn = $("<button>")
      .text('x')
      .attr({
        class: "btnRemove",
        'data-key': key
    });
    $("<td>").appendTo($row).append($btn);

    return $row;
  },

  // Renders the table
  render: function(data) {

    // table body
    var $tbl = $("#tblCards");

    // clear table 
    $tbl.empty();

    // append a row for each card
    $.each(data, function(key) {
      $tbl.append(table.newRow(this, key));
    });
  }
};

// Displays the number of cards.
function displayTotalCards(count) {
  $("#totalCards").text(count);
}

$(document).ready(function() {
    // listen for submit button click on add card form
    $("#btnSubmit").on("click", function(event) {
        event.preventDefault();
        form.submit();
    });

    // listen for click on remove button
    $("tbody").on("click", function(event) {
      // get the key
      var key = $(event.target).attr("data-key");

      // TODO ask user to confirm removing the card

      // remove card from database
      database.removeCard(key);
    });
});
</script>
</body>
</html>
